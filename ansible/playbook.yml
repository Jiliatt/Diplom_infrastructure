---
- name: Setup all nodes
  hosts: all  # ← РАБОТАЕТ! 3 хоста
  become: yes
  tasks:
    - name: Install dependencies
      apt:
        name:
          - snapd
          - openjdk-17-jre-headless
          - nginx
        state: present
        update_cache: yes

    - name: Install MicroK8s on ALL nodes
      shell: snap install microk8s --classic --channel=1.28 || true

- name: Setup Master (k8s-master ONLY)
  hosts: k8s-master  # ← ТОЧНЫЙ ХОСТ!
  become: yes
  tasks:
    - name: Wait for microk8s status ready
      shell: microk8s status --wait-ready
      retries: 10
      delay: 10

    - name: Enable MicroK8s addons
      shell: microk8s enable dns helm3 storage registry || true

    - name: Deploy ArgoCD
      shell: |
        microk8s kubectl create ns argocd || true
        microk8s helm repo add argo https://argoproj.github.io/argo-helm || true
        microk8s helm repo update
        microk8s helm install argocd argo/argo-cd --namespace argocd || true

    - name: Get ArgoCD password
      shell: microk8s kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
      register: argocd_pass

    - name: Save credentials
      copy:
        content: |
          ArgoCD UI: microk8s kubectl port-forward svc/argocd-server -n argocd 8080:443
          Username: admin
          Password: {{ argocd_pass.stdout }}
        dest: /home/ubuntu/ARGOCD-CREDENTIALS.txt
     
    - name: Setup ubuntu for microk8s
      block:
        - name: Add ubuntu to microk8s group
          user:
            name: ubuntu
            groups: microk8s
            append: yes
     
        - meta: reset_connection

        - name: Create kube config dir
          file:
            path: /home/ubuntu/.kube
            state: directory
            owner: ubuntu
            group: ubuntu
        
        - name: Copy microk8s config
          shell: microk8s config > /home/ubuntu/.kube/config
          become: no
          become_user: ubuntu
            
    - name: Generate worker join token
      shell: microk8s add-node
      register: join_token

    - name: Save join token to file
      copy:
        content: "{{ join_token.stdout }}"
        dest: /home/ubuntu/worker-join-token.txt

- name: Setup Worker (k8s-worker ONLY)
  hosts: k8s-worker  # ← ТОЧНЫЙ ХОСТ!
  become: yes
  vars:
    master_ip: "158.160.14.198"
  tasks:
    - name: Wait microk8s ready
      shell: microk8s status --wait-ready
      retries: 10
      delay: 10

    - name: Add ubuntu to microk8s group on worker
      user:
        name: ubuntu
        groups: microk8s
        append: yes
      ignore_errors: yes
    
        #- name: Get join token from master (delegate to master)
        #shell: ssh ubuntu@158.160.14.198 "cat /home/ubuntu/worker-join-token.txt | head -n1"
        #register: join_cmd

        #- name: Join !
        #shell: "{{ join_cmd.stdout }}"

      
- name: Setup Jenkins (jenkins-node ONLY)
  hosts: jenkins-node  # ← ТОЧНЫЙ ХОСТ!
  become: yes
  tasks:
    - name: Install Jenkins deps
      apt:
        name: openjdk-17-jdk
        state: present

    - name: Start Docker
      systemd:
        name: docker
        enabled: yes
        state: started
