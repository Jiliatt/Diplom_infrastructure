---
- name: Setup all nodes
  hosts: all  # ← РАБОТАЕТ! 3 хоста
  become: yes
  tasks:
    - name: Install dependencies
      apt:
        name:
          - snapd
          - openjdk-17-jre-headless
          - nginx
        state: present
        update_cache: yes

    - name: Install MicroK8s on ALL nodes
      shell: snap install microk8s --classic --channel=1.28 || true

- name: Setup Master (k8s-master ONLY)
  hosts: k8s-master  # ← ТОЧНЫЙ ХОСТ!
  become: yes
  tasks:
    - name: Wait for microk8s status ready
      shell: microk8s status --wait-ready
      retries: 10
      delay: 10

    - name: Enable MicroK8s addons
      shell: microk8s enable dns helm3 storage registry || true

    - name: Deploy ArgoCD
      shell: |
        microk8s kubectl create ns argocd || true
        microk8s helm3 repo add argo https://argoproj.github.io/argo-helm || true
        microk8s helm3 repo update
        microk8s helm3 install argocd argo/argo-cd --namespace argocd || true

    - name: Get ArgoCD password
      shell: microk8s kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
      register: argocd_pass

    - name: Save credentials
      copy:
        content: |
          ArgoCD UI: microk8s kubectl port-forward svc/argocd-server -n argocd 8080:443
          Username: admin
          Password: {{ argocd_pass.stdout }}
        dest: /home/ubuntu/ARGOCD-CREDENTIALS.txt
     
    - name: Setup ubuntu for microk8s
      block:
        - name: Add ubuntu to microk8s group
          user:
            name: ubuntu
            groups: microk8s
            append: yes
     
        - meta: reset_connection

        - name: Create kube config dir
          file:
            path: /home/ubuntu/.kube
            state: directory
            owner: ubuntu
            group: ubuntu
        
        - name: Copy microk8s config
          shell: microk8s config > /home/ubuntu/.kube/config
          become: no
          become_user: ubuntu
            
    - name: Generate worker join token
      shell: microk8s add-node
      register: join_token

    - name: Save join token to file
      copy:
        content: "{{ join_token.stdout }}"
        dest: /home/ubuntu/worker-join-token.txt



- name: GitOps Deploy diplom-app (k8s-master)
  hosts: k8s-master
  become: no  # ubuntu user
  tasks:
    - name: SSH keygen for GitHub
      shell: ssh-keygen -t ed25519 -C "k8s-master" -f ~/.ssh/id_ed25519 -N ""
      ignore_errors: yes

    - name: Show pubkey (manual GitHub step)
      shell: cat ~/.ssh/id_ed25519.pub
      register: ssh_pubkey

    - debug:
        msg: |
          ADD TO GITHUB: https://github.com/Jiliatt/Diplom_infrastructure → Settings → SSH keys
          KEY: {{ ssh_pubkey.stdout }}

    - name: Clone repo
      git:
        repo: git@github.com:Jiliatt/Diplom_infrastructure.git
        dest: ~/Diplom_infrastructure
        version: feature/k8s-deploy
        accept_hostkey: yes
        key_file: ~/.ssh/id_ed25519

    - name: Namespace + Argo App
      shell: |
        microk8s kubectl apply -f ~/Diplom_infrastructure/k8s-manifests/namespace.yaml
        microk8s kubectl apply -f ~/Diplom_infrastructure/tmp/diplom-app.yaml -n argocd
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config




- name: Setup Worker (k8s-worker ONLY)
  hosts: k8s-worker  # ← ТОЧНЫЙ ХОСТ!
  become: yes
  vars:
    master_ip: "{{ hostvars['k8s-master']['ansible_host'] }}"
  tasks:
    - name: Wait microk8s ready
      shell: microk8s status --wait-ready
      retries: 10
      delay: 10

    - name: Add ubuntu to microk8s group on worker
      user:
        name: ubuntu
        groups: microk8s
        append: yes
      ignore_errors: yes
    
        #нужно для подключения воркер ноды (инчае будет сингл мастер нода)
        #- name: Wait for join token on master
        #wait_for_connection:
        #host: "{{ master_ip }}"
        #port: 22
        #delegate_to: localhost

        #- name: Get join token from master (SSH)
        #shell: ssh ubuntu@{{ master_ip }} "cat /home/ubuntu/worker-join-token.txt"
        #register: join_cmd

        #- name: Join cluster!
        #shell: "{{ join_cmd.stdout_lines[0] }}"  # ← Только первую строку!
        #become: yes


      
- name: Setup Jenkins (srv-monitoring ONLY)
  hosts: jenkins-node  # ← ТОЧНЫЙ ХОСТ!
  become: yes
  tasks:
    - name: Install Jenkins deps
      apt:
        name: openjdk-17-jdk
        state: present

    - name: Start Docker
      systemd:
        name: docker
        enabled: yes
        state: started

- name: Deploy K8s Logging (Loki/Promtail)
  hosts: k8s-master
  become: yes
  vars:
    srv_monitoring_ip: "{{ hostvars['jenkins-node']['ansible_host'] }}"
  tasks:
    - name: Add Grafana Helm
      shell: microk8s helm3 repo add grafana https://grafana.github.io/helm-charts

    - name: Update repos
      shell: microk8s helm3 repo update
    
    - name: Enable ONLY Promtail 
      shell: |
        microk8s helm3 upgrade --install promtail grafana/promtail \
          --namespace logging --create-namespace \
          --set "config.clients[0].url=http://{{ srv_monitoring_ip }}:3100/loki/api/v1/push"


- name: Auto-config srv vars/main.yml
  hosts: k8s-master
  become: no  # kubectl без sudo
  vars:
    srv_monitoring_ip: "{{ hostvars['jenkins-node']['ansible_host'] }}"
  tasks:
    - name: Get K8s node IP
      shell: microk8s kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}'
      register: k8s_node
      environment: 
        KUBECONFIG: /home/ubuntu/.kube/config


    - name: Get NodePort
      shell: microk8s kubectl get svc diplom-app -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "30080"
      register: node_port
      environment:          
        KUBECONFIG: /home/ubuntu/.kube/config

    - name: Get K8s API
      shell: microk8s kubectl cluster-info | grep 'control plane' | awk '{print $NF}'
      register: k8s_api
      environment:          
        KUBECONFIG: /home/ubuntu/.kube/config

    - name: Create monitoring configs dir
      file:
        path: /opt/monitoring/configs
        state: directory
        owner: root
        group: root
        mode: '0755'
      delegate_to: jenkins-node


    - name: Update srv vars/main.yml
      shell: |
        sudo install -D -m 644 /dev/stdin /opt/monitoring/configs/vars/main.yml << EOF
        app_target: "{{ k8s_node.stdout }}:{{ node_port.stdout }}"
        k8s_api: "{{ k8s_api.stdout }}"
        telegram_bot_token: "8503785351:AAEeSuzGp3y7CMZt1rjFuUw4vDUMEM3F_RU"
        telegram_chat_id: "980315984"
        EOF
      delegate_to: jenkins-node

    - name: Restart prometheus
      shell: cd /opt/monitoring && docker-compose restart prometheus
      delegate_to: jenkins-node
